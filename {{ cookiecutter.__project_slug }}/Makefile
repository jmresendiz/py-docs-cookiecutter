.PHONY: help setup deps deps-core deps-test deps-all docker docker-up docker-down docker-logs test test-cov clean install start dev prod test-crud test-api test-api-verbose

# Default target
help:
	@echo "Available commands:"
	@echo ""
	@echo "ğŸš€ Application Commands:"
	@echo "  start         - Start FastAPI app (localhost only)"
	@echo "  dev-server    - Start FastAPI app in dev mode (accessible from network)"
	@echo "  prod-server   - Start FastAPI app in production mode"
	@echo ""
	@echo "ğŸ”§ Development Commands:"
	@echo "  setup         - Setup Python development environment"
	@echo "  deps          - Install all dependencies (default)"
	@echo "  deps-core     - Install core dependencies only"
	@echo "  deps-test     - Install testing dependencies only"
	@echo "  deps-all      - Install all dependencies (same as deps)"
	@echo "  install       - Install package in development mode"
	@echo "  test          - Run unit tests with pytest"
	@echo "  test-cov      - Run tests with coverage report"
	@echo "  test-api      - Run API CRUD tests"
	@echo "  test-api-verbose - Run API tests with verbose output"
	@echo "  clean         - Clean build artifacts"
	@echo ""
	@echo "ğŸ³ Docker Commands:"
	@echo "  docker-build  - Build Docker image"
	@echo "  docker-up     - Build and start compose stack (.build/docker-compose.yml)"
	@echo "  docker-down   - Stop and remove compose stack"
	@echo "  docker-logs   - Tail logs from compose stack"
	@echo ""
	@echo "ğŸ“š Other Commands:"
	@echo "  help          - Show this help message"
	@echo "  dev           - Quick development workflow (setup + install + test)"
	@echo "  full-setup    - Full setup including dependencies"

# Setup Python development environment
setup:
	@echo "ğŸ”§ Setting up Python development environment..."
	@bash -c "./scripts/setup_env.sh"

# Install all dependencies (default behavior)
deps: deps-all

# Install core dependencies only
deps-core:
	@echo "ğŸ“¦ Installing core dependencies..."
	@bash -c "./scripts/add_deps.sh --core"

# Install testing dependencies only
deps-test:
	@echo "ğŸ§ª Installing testing dependencies..."
	@bash -c "./scripts/add_deps.sh --test"

# Install all dependencies
deps-all:
	@echo "ğŸ“¦ Installing all dependencies..."
	@bash -c "./scripts/add_deps.sh --all"

# Build Docker image
docker-build:
	@echo "ğŸ³ Building Docker image..."
	@bash -c "./scripts/build_docker.sh"

# Docker Compose helpers (keep Docker files under .build/)
docker-up: docker-down
	@echo "ğŸ³ Building and starting docker-compose stack..."
	@bash -c "docker compose -f .build/docker-compose.yml up --build $(ARGS)"


docker-down:
	@echo "ğŸ›‘ Stopping docker-compose stack..."
	@bash -c "docker compose -f .build/docker-compose.yml down"

docker-logs:
	@echo "ğŸ“œ Tailing docker-compose logs... (Ctrl+C to stop)"
	@bash -c "docker compose -f .build/docker-compose.yml logs -f"

# Run unit tests
test:
	@echo "ğŸ§ª Running unit tests..."
	@echo "ğŸ“ Test directory: $(PWD)/tests/"
	@echo "ğŸ” Verbose output enabled"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	poetry run pytest tests/ -v
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "âœ… Unit tests completed!"

# Run tests with coverage
test-cov:
	@echo "ğŸ§ª Running tests with coverage..."
	@echo "ğŸ“ Test directory: $(PWD)/tests/"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	poetry run pytest tests/ --cov=src/{{ cookiecutter.__project_slug }} --cov-report=term-missing
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "âœ… Coverage tests completed!"


# Install package in development mode
install:
	@echo "ğŸ“¦ Installing package in development mode..."
	poetry install

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -rf build/
	rm -rf dist/
	rm -rf *.egg-info/
	rm -rf .coverage
	rm -rf htmlcov/
	rm -rf .pytest_cache/
	find . -type d -name "__pycache__" -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	@echo "âœ… Cleanup completed!"

# Quick development workflow
dev: setup install test
	@echo "âœ… Development environment ready!"

# Full setup including dependencies
full-setup: setup install
	@echo "âœ… Full setup completed!"

# Start the FastAPI application
start:
	@echo "ğŸš€ Starting FastAPI application..."
	@echo "ğŸ“– API Documentation: http://127.0.0.1:8000/docs"
	@echo "ğŸ” ReDoc: http://127.0.0.1:8000/redoc"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	poetry run uvicorn {{ cookiecutter.__project_slug }}.{{ cookiecutter.__project_slug }}:app --reload --host 127.0.0.1 --port 8000

# Start in development mode (accessible from other devices)
dev-server:
	@echo "ğŸŒ Starting FastAPI application in development mode..."
	@echo "ğŸ“– API Documentation: http://0.0.0.0:8000/docs"
	@echo "ğŸ” ReDoc: http://0.0.0.0:8000/redoc"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	poetry run uvicorn {{ cookiecutter.__project_slug }}.{{ cookiecutter.__project_slug }}:app --reload --host 0.0.0.0 --port 8000

# Start in production mode
prod-server:
	@echo "ğŸš€ Starting FastAPI application in production mode..."
	@echo "ğŸ“– API Documentation: http://0.0.0.0:8000/docs"
	@echo "ğŸ” ReDoc: http://0.0.0.0:8000/redoc"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	poetry run uvicorn {{ cookiecutter.__project_slug }}.{{ cookiecutter.__project_slug }}:app --host 0.0.0.0 --port 8000

# Run CRUD flow tests
test-crud:
	@echo "ğŸ§ª Running complete CRUD flow tests..."
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	poetry run python scripts/test_crud_flow.py
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "âœ… CRUD flow tests completed!"

# Run API CRUD tests
test-api:
	@echo "ğŸ§ª Running complete API CRUD tests..."
	@echo "âš ï¸  Make sure the API is running with 'make start' in another terminal"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	poetry run python scripts/test_api_full_crud.py
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "âœ… API CRUD tests completed!"

# Run API CRUD tests with verbose output
test-api-verbose:
	@echo "ğŸ§ª Running complete API CRUD tests (verbose)..."
	@echo "âš ï¸  Make sure the API is running with 'make start' in another terminal"
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	poetry run python scripts/test_api_full_crud.py --verbose
	@echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
	@echo "âœ… API CRUD tests completed!"
